<!DOCTYPE html><html lang="en">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Mybatis框架设计 - lipeng's blog</title>
<meta name="description" content="  1. Mybatis框架设计          1.1. 接口层–和数据库交互的方式                  1.1.1. 使用Mybatis提供的API          1.1.2. 使用Mapper接口                    1.2. 数据处理层                ...">
<link rel="canonical" href="http://localhost:4000/ProgramNote/mybatis/2017/12/11/Mybatis%E6%9E%84%E6%9E%B6%E8%AE%BE%E8%AE%A1.html"><link rel="alternate" type="application/rss+xml" title="lipeng's blog" href="http://localhost:4000/ProgramNote/feed.xml">
<!-- for Safari on iOS https://developer.apple.com/ios/human-interface-guidelines/icons-and-images/app-icon/ --><link rel="apple-touch-icon" sizes="180x180" href="/ProgramNote/assets/images/logo/icon-180x180.png"><link rel="apple-touch-icon" sizes="167x167" href="/ProgramNote/assets/images/logo/icon-167x167.png"><link rel="apple-touch-icon" sizes="152x152" href="/ProgramNote/assets/images/logo/icon-152x152.png"><link rel="apple-touch-icon" sizes="120x120" href="/ProgramNote/assets/images/logo/icon-120x120.png"><link rel="shortcut icon" href="/ProgramNote/assets/images/logo/icon-120x120.png">
<!-- for Chrome on Android https://developer.chrome.com/multidevice/android/installtohomescreen -->
<meta name="mobile-web-app-capable" content="yes"><link rel="icon" sizes="192x192" href="/ProgramNote/assets/images/logo/icon-192x192.png">
<!-- for Edge on Windows 10 https://msdn.microsoft.com/en-us/library/dn255024(v=vs.85).aspx --><meta name="msapplication-TileImage" content="/ProgramNote/assets/images/logo/icon-144x144.png"><meta name="msapplication-square310x310logo" content="/ProgramNote/assets/images/logo/icon-310x310.png"><meta name="msapplication-wide310x150logo" content="/ProgramNote/assets/images/logo/icon-310x150.png"><meta name="msapplication-square150x150logo" content="/ProgramNote/assets/images/logo/icon-150x150.png"><meta name="msapplication-square70x70logo" content="/ProgramNote/assets/images/logo/icon-70x70.png">
<meta name="msapplication-TileColor" content="#eeeeee"><link rel="stylesheet" href="/ProgramNote/assets/css/blog.css">
    <style></style>
    <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script></head>
  <body>
    <div class="m-page-stage js-page-stage"><div class="m-page-content"><header class="m-page-header main clearfix"><a class="site-title" title="lipeng's Blog
" href="/ProgramNote/">lipeng's blog</a><div class="site-logo"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#666666;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg></div>
  <nav>
    <ul class="inline-list"><li><a href="/ProgramNote/">Home</a></li><li><a href="/ProgramNote/all.html">All</a></li><li><a href="/ProgramNote/about.html">About</a></li><li><a type="application/rss+xml" href="/ProgramNote/feed.xml">RSS</a></li>
    </ul>
  </nav>
</header>
<div class="m-page-main"><div class="m-post">
	<div class="main js-main">
		<div class="col-1">
			<article itemscope itemtype="http://schema.org/BlogPosting">
				<meta itemprop="mainEntityOfPage" itemscope itemType="https://schema.org/WebPage"/>
				<header class="article-header"><h1 itemprop="headline" itemprop="name headline">Mybatis框架设计</h1><div class="m-article-data clearfix"><meta itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="lipeng"/></meta><ul class="inline-list tag-wrapper"><li>
          <a class="round-rect-button" href="/ProgramNote/all.html?tag=Mybatis">Mybatis</a>
        </li><li>
          <a class="round-rect-button" href="/ProgramNote/all.html?tag=%E6%9E%84%E6%9E%B6">构架</a>
        </li></ul><div class="other-wrapper"><div class="date-wrapper"><time class="article-meta" datetime="2017-12-11T13:51:29+08:00"
          itemprop="datePublished">Dec 11, 2017
        </time></div>
  </div>
</div>
</header>
				<div class="m-article-content js-article-content" itemprop="articleBody"><!-- TOC -->

<ul>
  <li><a href="#1-mybatis%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1">1. Mybatis框架设计</a>
    <ul>
      <li><a href="#11-%E6%8E%A5%E5%8F%A3%E5%B1%82--%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%A4%E4%BA%92%E7%9A%84%E6%96%B9%E5%BC%8F">1.1. 接口层–和数据库交互的方式</a>
        <ul>
          <li><a href="#111-%E4%BD%BF%E7%94%A8mybatis%E6%8F%90%E4%BE%9B%E7%9A%84api">1.1.1. 使用Mybatis提供的API</a></li>
          <li><a href="#112-%E4%BD%BF%E7%94%A8mapper%E6%8E%A5%E5%8F%A3">1.1.2. 使用Mapper接口</a></li>
        </ul>
      </li>
      <li><a href="#12-%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%B1%82">1.2. 数据处理层</a>
        <ul>
          <li><a href="#121-%E5%8F%82%E6%95%B0%E6%98%A0%E5%B0%84%E5%92%8C%E5%8A%A8%E6%80%81sql%E8%AF%AD%E5%8F%A5%E7%94%9F%E6%88%90">1.2.1. 参数映射和动态SQL语句生成</a></li>
          <li>[1.2.2. SQL语句的执行以及封装查询结果集成List<E>](#122-sql%E8%AF%AD%E5%8F%A5%E7%9A%84%E6%89%A7%E8%A1%8C%E4%BB%A5%E5%8F%8A%E5%B0%81%E8%A3%85%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E9%9B%86%E6%88%90liste)</E></li>
        </ul>
      </li>
      <li><a href="#13-%E6%A1%86%E6%9E%B6%E6%94%AF%E6%92%91%E5%B1%82">1.3. 框架支撑层</a>
        <ul>
          <li><a href="#131-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6">1.3.1. 事务管理机制</a></li>
          <li><a href="#132-%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6">1.3.2. 连接池管理机制</a></li>
          <li><a href="#133-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6">1.3.3. 缓存机制</a></li>
          <li><a href="#134-sql%E8%AF%AD%E5%8F%A5%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F">1.3.4. SQL语句配置方式</a></li>
          <li><a href="#135-%E5%BC%95%E5%AF%BC%E5%B1%82">1.3.5. 引导层</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#2-mybatis%E4%B8%BB%E8%A6%81%E6%9E%84%E4%BB%B6%E4%B8%80%E8%B5%B7%E7%9B%B8%E4%BA%92%E5%85%B3%E7%B3%BB">2. Mybatis主要构件一起相互关系</a></li>
  <li><a href="#3-%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90">3. 实例分析</a>
    <ul>
      <li><a href="#31-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87">3.1. 数据准备</a>
        <ul>
          <li><a href="#311-%E6%95%B0%E6%8D%AE%E5%BA%93">3.1.1. 数据库</a></li>
          <li><a href="#312-mybatis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-mybatisconfigxml">3.1.2. Mybatis配置文件 mybatisConfig.xml</a></li>
          <li><a href="#313-%E5%88%9B%E5%BB%BAemployee%E5%AE%9E%E4%BD%93bean-%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AEmapper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">3.1.3. 创建Employee实体Bean 以及配置Mapper配置文件</a></li>
          <li><a href="#314-%E6%BC%94%E7%A4%BA%E4%BB%A3%E7%A0%81">3.1.4. 演示代码</a></li>
        </ul>
      </li>
      <li><a href="#32-sqlsession%E5%B7%A5%E4%BD%9C%E5%B7%A5%E7%A8%8B%E5%88%86%E6%9E%90">3.2. SqlSession工作工程分析</a>
        <ul>
          <li><a href="#321-%E5%BC%80%E5%90%AF%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE%E4%BC%9A%E8%AF%9D--%E5%88%9B%E5%BB%BAsqlsession%E5%AF%B9%E8%B1%A1">3.2.1. 开启一个数据库访问会话–创建SqlSession对象</a></li>
          <li><a href="#322-%E4%B8%BAsqlsession%E4%BC%A0%E9%80%92%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E7%9A%84sql%E8%AF%AD%E5%8F%A5statementid%E5%92%8C%E5%8F%82%E6%95%B0%EF%BC%8C%E7%84%B6%E5%90%8E%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C">3.2.2. 为SqlSession传递一个配置的SQL语句StatementId和参数，然后返回结果</a></li>
          <li><a href="#323-mybatis%E6%89%A7%E8%A1%8C%E5%99%A8executor%E6%A0%B9%E6%8D%AEsqlsession%E4%BC%A0%E9%80%92%E7%9A%84%E5%8F%82%E6%95%B0%E6%89%A7%E8%A1%8Cquery%E6%96%B9%E6%B3%95">3.2.3. Mybatis执行器Executor根据SqlSession传递的参数执行query()方法</a></li>
          <li><a href="#324-statementhandler%E5%AF%B9%E8%B1%A1%E8%B4%9F%E8%B4%A3%E8%AE%BE%E7%BD%AEstatement%E5%AF%B9%E8%B1%A1%E4%B8%AD%E7%9A%84%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0%E3%80%81%E5%A4%84%E7%90%86jdbc%E8%BF%94%E5%9B%9E%E7%9A%84resultset%EF%BC%8C%E5%B0%86resultset%E5%8A%A0%E5%B7%A5%E4%B8%BAlist-%E9%9B%86%E5%90%88%E8%BF%94%E5%9B%9E">3.2.4. StatementHandler对象负责设置Statement对象中的查询参数、处理JDBC返回的resultSet，将resultSet加工为List 集合返回</a></li>
          <li><a href="#325-statementhandler-%E7%9A%84parameterizestatement-%E6%96%B9%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0">3.2.5. StatementHandler 的parameterize(statement) 方法的实现</a></li>
          <li>[3.2.6. StatementHandler 的List<E> query(Statement statement, ResultHandler resultHandler)方法的实现](#326-statementhandler-%E7%9A%84liste-querystatement-statement-resulthandler-resulthandler%E6%96%B9%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0)</E></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<!-- /TOC -->
<h1 id="1-mybatis框架设计">1. Mybatis框架设计</h1>
<p><img src="/ProgramNote/assets/Image/mybatis/16.png" alt="Mybatis设计图" title="设计图" /></p>

<h2 id="11-接口层和数据库交互的方式">1.1. 接口层–和数据库交互的方式</h2>
<p>Mybatis和数据库交互有两种方式</p>
<ul>
  <li>使用Mybatis提供的API</li>
  <li>使用Mapper接口</li>
</ul>

<h3 id="111-使用mybatis提供的api">1.1.1. 使用Mybatis提供的API</h3>

<p>这是传统的传递Statement Id 和查询参数给 SqlSession 对象，使用 SqlSession对象完成和数据库的交互；</p>

<p>MyBatis 提供了非常方便和简单的API，供用户实现对数据库的增删改查数据操作，以及对数据库连接信息和MyBatis 自身配置信息的维护操作。</p>

<p><img src="/ProgramNote/assets/Image/mybatis/17.png" alt="Mybatis设计图" title="设计图" /></p>

<p>创建一个和数据库打交道的SqlSession对象，然后根据Statement Id 和参数来操作数据库，这种方式固然很简单和实用，但是它不符合面向对象语言的概念和面向接口编程的编程习惯。由于面向接口的编程是面向对象的大趋势，MyBatis 为了适应这一趋势，增加了第二种使用MyBatis 支持接口（Interface）调用方式。</p>

<h3 id="112-使用mapper接口">1.1.2. 使用Mapper接口</h3>

<p>MyBatis 将配置文件中的每一个<mapper> 节点抽象为一个 Mapper 接口，而这个接口中声明的方法和跟<mapper> 节点中的&lt;select|update|delete|insert&gt; 节点项对应，即&lt;select|update|delete|insert&gt; 节点的id值为Mapper 接口中的方法名称，parameterType 值表示Mapper 对应方法的入参类型，而resultMap 值则对应了Mapper 接口表示的返回值类型或者返回结果集的元素类型。</mapper></mapper></p>

<p><img src="/ProgramNote/assets/Image/mybatis/18.png" alt="Mybatis设计图" title="设计图" /></p>

<p>根据MyBatis 的配置规范配置好后，通过SqlSession.getMapper(XXXMapper.class) 方法，MyBatis 会根据相应的接口声明的方法信息，通过动态代理机制生成一个Mapper 实例，我们使用Mapper 接口的某一个方法时，MyBatis 会根据这个方法的方法名和参数类型，确定Statement Id，底层还是通过SqlSession.select(“statementId”,parameterObject);或者SqlSession.update(“statementId”,parameterObject); 等等来实现对数据库的操作.</p>

<p>MyBatis 引用Mapper 接口这种调用方式，纯粹是为了满足面向接口编程的需要。（其实还有一个原因是在于，面向接口的编程，使得用户在接口上可以使用注解来配置SQL语句，这样就可以脱离XML配置文件，实现“0配置”）。</p>

<h2 id="12-数据处理层">1.2. 数据处理层</h2>
<p>数据处理层是Mybatis的核心，主要完成</p>
<ul>
  <li>通过传入参数构建动态SQL语句</li>
  <li>SQL语句的执行</li>
  <li>封装查询结果集成List<E></E></li>
</ul>

<h3 id="121-参数映射和动态sql语句生成">1.2.1. 参数映射和动态SQL语句生成</h3>
<p>Mybatis通过传入参数值使用OGNL动态构造SQL语句。</p>

<p>参数映射是指java数据类型和jdbc数据类型之间的转换，这里包含两个过程</p>
<ul>
  <li>查询阶段，要将java类型的数据转换成jdbc类型的数据，通过preparedStatement.setXXX() 来设值；</li>
  <li>另一个就是对resultset查询结果集的jdbcType 数据转换成java 数据类型。</li>
</ul>

<h3 id="122-sql语句的执行以及封装查询结果集成list">1.2.2. SQL语句的执行以及封装查询结果集成List<E></E></h3>
<p>动态SQL语句生成之后，MyBatis 将执行SQL语句，并将可能返回的结果集转换成List<E> 列表。</E></p>

<p>MyBatis 在对结果集的处理中，支持结果集关系一对多和多对一的转换，并且有两种支持方式，一种为嵌套查询语句的查询，还有一种是嵌套结果集的查询。</p>

<h2 id="13-框架支撑层">1.3. 框架支撑层</h2>
<h3 id="131-事务管理机制">1.3.1. 事务管理机制</h3>
<p><a href="/05-Mybatis/04-Mybatis事务管理.md">Mybatis事务</a></p>
<h3 id="132-连接池管理机制">1.3.2. 连接池管理机制</h3>
<p><a href="/05-Mybatis/03-Mybatis数据源和连接池">Mybatis数据源和连接池</a></p>
<h3 id="133-缓存机制">1.3.3. 缓存机制</h3>
<p>为了提高数据利用率和减小服务器和数据库的压力，MyBatis 会对于一些查询提供会话级别的数据缓存，会将对某一次查询，放置到SqlSession 中，在允许的时间间隔内，对于完全相同的查询，MyBatis 会直接将缓存结果返回给用户，而不用再到数据库中查找。</p>

<h3 id="134-sql语句配置方式">1.3.4. SQL语句配置方式</h3>

<p>传统的MyBatis 配置SQL 语句方式就是使用XML文件进行配置的，但是这种方式不能很好地支持面向接口编程的理念，为了支持面向接口的编程，MyBatis 引入了Mapper接口的概念，面向接口的引入，对使用注解来配置SQL 语句成为可能，用户只需要在接口上添加必要的注解即可，不用再去配置XML文件了，但是，目前的MyBatis 只是对注解配置SQL 语句提供了有限的支持，某些高级功能还是要依赖XML配置文件配置SQL 语句。</p>

<h3 id="135-引导层">1.3.5. 引导层</h3>
<p>引导层是配置和启动MyBatis 配置信息的方式。</p>

<p>MyBatis 提供两种方式来引导MyBatis</p>
<ul>
  <li>基于XML配置文件的方式</li>
  <li>基于Java API 的方式</li>
</ul>

<p><a href="http://blog.csdn.net/luanlouis/article/details/35570809">Java Persistence with MyBatis 3(中文版) 第二章 引导MyBatis</a></p>

<h1 id="2-mybatis主要构件一起相互关系">2. Mybatis主要构件一起相互关系</h1>

<p>Mybatis主要的核心部件（非全部）</p>
<ul>
  <li>SqlSession
    <ul>
      <li>作为MyBatis工作的主要顶层API，表示和数据库交互的会话，完成必要数据库增删改查功能</li>
    </ul>
  </li>
  <li>Executor
    <ul>
      <li>MyBatis执行器，是MyBatis 调度的核心，负责SQL语句的生成和查询缓存的维护</li>
    </ul>
  </li>
  <li>StatementHandler
    <ul>
      <li>封装了JDBC Statement操作，负责对JDBC statement 的操作，如设置参数、将Statement结果集转换成List集合。</li>
    </ul>
  </li>
  <li>ParameterHandler
    <ul>
      <li>负责对用户传递的参数转换成JDBC Statement 所需要的参数，</li>
    </ul>
  </li>
  <li>ResultSetHandler
    <ul>
      <li>负责将JDBC返回的ResultSet结果集对象转换成List类型的集合；</li>
    </ul>
  </li>
  <li>TypeHandler
    <ul>
      <li>负责java数据类型和jdbc数据类型之间的映射和转换</li>
    </ul>
  </li>
  <li>MappedStatement
    <ul>
      <li>
        <table>
          <tbody>
            <tr>
              <td>MappedStatement维护了一条&lt;select</td>
              <td>update</td>
              <td>delete</td>
              <td>insert&gt;节点的封装，</td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>
  </li>
  <li>SqlSource
    <ul>
      <li>负责根据用户传递的parameterObject，动态地生成SQL语句，将信息封装到BoundSql对象中，并返回</li>
    </ul>
  </li>
  <li>BoundSql
    <ul>
      <li>表示动态生成的SQL语句以及相应的参数信息</li>
    </ul>
  </li>
  <li>Configuration
    <ul>
      <li>MyBatis所有的配置信息都维持在Configuration对象之中。</li>
    </ul>
  </li>
</ul>

<p><img src="/ProgramNote/assets/Image/mybatis/19.png" alt="Mybatis设计图" title="设计图" /></p>

<h1 id="3-实例分析">3. 实例分析</h1>
<h2 id="31-数据准备">3.1. 数据准备</h2>

<h3 id="311-数据库">3.1.1. 数据库</h3>
<pre><code class="language-SQL">   
   --创建一个员工基本信息表
    create  table "EMPLOYEES"(
        "EMPLOYEE_ID" NUMBER(6) not null,
       "FIRST_NAME" VARCHAR2(20),
       "LAST_NAME" VARCHAR2(25) not null,
       "EMAIL" VARCHAR2(25) not null unique,
       "SALARY" NUMBER(8,2),
        constraint "EMP_EMP_ID_PK" primary key ("EMPLOYEE_ID")
    );
    comment on table EMPLOYEES is '员工信息表';
    comment on column EMPLOYEES.EMPLOYEE_ID is '员工id';
    comment on column EMPLOYEES.FIRST_NAME is 'first name';
    comment on column EMPLOYEES.LAST_NAME is 'last name';
    comment on column EMPLOYEES.EMAIL is 'email address';
    comment on column EMPLOYEES.SALARY is 'salary';
    
    --添加数据
	insert into EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, SALARY)
	values (100, 'Steven', 'King', 'SKING', 24000.00);
	
	insert into EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, SALARY)
	values (101, 'Neena', 'Kochhar', 'NKOCHHAR', 17000.00);
	
	insert into EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, SALARY)
	values (102, 'Lex', 'De Haan', 'LDEHAAN', 17000.00);
	
	insert into EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, SALARY)
	values (103, 'Alexander', 'Hunold', 'AHUNOLD', 9000.00);
	
	insert into EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, SALARY)
	values (104, 'Bruce', 'Ernst', 'BERNST', 6000.00);
	
	insert into EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, SALARY)
	values (105, 'David', 'Austin', 'DAUSTIN', 4800.00);
	
	insert into EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, SALARY)
	values (106, 'Valli', 'Pataballa', 'VPATABAL', 4800.00);
	
	insert into EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, SALARY)
	values (107, 'Diana', 'Lorentz', 'DLORENTZ', 4200.00);    

</code></pre>

<h3 id="312-mybatis配置文件-mybatisconfigxml">3.1.2. Mybatis配置文件 mybatisConfig.xml</h3>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;environments</span> <span class="na">default=</span><span class="s">"development"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;environment</span> <span class="na">id=</span><span class="s">"development"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;transactionManager</span> <span class="na">type=</span><span class="s">"JDBC"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;dataSource</span> <span class="na">type=</span><span class="s">"POOLED"</span><span class="nt">&gt;</span>
	 <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driver"</span> <span class="na">value=</span><span class="s">"oracle.jdbc.driver.OracleDriver"</span> <span class="nt">/&gt;</span>  
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"jdbc:oracle:thin:@localhost:1521:xe"</span> <span class="nt">/&gt;</span>  
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"louis"</span> <span class="nt">/&gt;</span>  
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"123456"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/dataSource&gt;</span>
    <span class="nt">&lt;/environment&gt;</span>
  <span class="nt">&lt;/environments&gt;</span>
    <span class="nt">&lt;mappers&gt;</span>
       <span class="nt">&lt;mapper</span>  <span class="na">resource=</span><span class="s">"com/louis/mybatis/domain/EmployeesMapper.xml"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/mappers&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>

</code></pre></div></div>

<h3 id="313-创建employee实体bean-以及配置mapper配置文件">3.1.3. 创建Employee实体Bean 以及配置Mapper配置文件</h3>
<pre><code class="language-Java">package com.louis.mybatis.model;

import java.math.BigDecimal;

public class Employee {
    private Integer employeeId;

    private String firstName;

    private String lastName;

    private String email;

    private BigDecimal salary;

    public Integer getEmployeeId() {
        return employeeId;
    }

    public void setEmployeeId(Integer employeeId) {
        this.employeeId = employeeId;
    }

    public String getFirstName() {
        return firstName;
    }

    public void setFirstName(String firstName) {
        this.firstName = firstName;
    }

    public String getLastName() {
        return lastName;
    }

    public void setLastName(String lastName) {
        this.lastName = lastName;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public BigDecimal getSalary() {
        return salary;
    }

    public void setSalary(BigDecimal salary) {
        this.salary = salary;
    }
}
</code></pre>

<pre><code class="language-XML">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" &gt;
&lt;mapper namespace="com.louis.mybatis.dao.EmployeesMapper" &gt;

  &lt;resultMap id="BaseResultMap" type="com.louis.mybatis.model.Employee" &gt;
    &lt;id column="EMPLOYEE_ID" property="employeeId" jdbcType="DECIMAL" /&gt;
    &lt;result column="FIRST_NAME" property="firstName" jdbcType="VARCHAR" /&gt;
    &lt;result column="LAST_NAME" property="lastName" jdbcType="VARCHAR" /&gt;
    &lt;result column="EMAIL" property="email" jdbcType="VARCHAR" /&gt;
    &lt;result column="SALARY" property="salary" jdbcType="DECIMAL" /&gt;
  &lt;/resultMap&gt;
  
  &lt;select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" &gt;
    select 
    	EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, SALARY
    	from LOUIS.EMPLOYEES
    	where EMPLOYEE_ID = #{employeeId,jdbcType=DECIMAL}
  &lt;/select&gt;
&lt;/mapper&gt;
</code></pre>

<p>MAVEN依赖</p>

<pre><code class="language-XML">  
    &lt;dependency&gt;  
            &lt;groupId&gt;org.mybatis&lt;/groupId&gt;  
            &lt;artifactId&gt;mybatis&lt;/artifactId&gt;  
            &lt;version&gt;3.2.7&lt;/version&gt;  
    &lt;/dependency&gt;  
      
    &lt;dependency&gt;  
        &lt;groupId&gt;com.oracle&lt;/groupId&gt;  
        &lt;artifactId&gt;ojdbc14&lt;/artifactId&gt;  
        &lt;version&gt;10.2.0.4.0&lt;/version&gt;  
    &lt;/dependency&gt; 
</code></pre>

<h3 id="314-演示代码">3.1.4. 演示代码</h3>
<pre><code class="language-Java">package com.louis.mybatis.test;

import java.io.InputStream;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import com.louis.mybatis.model.Employee;

/**
 * SqlSession 简单查询演示类
 * @author louluan
 */
public class SelectDemo {

	public static void main(String[] args) throws Exception {
		/*
		 * 1.加载mybatis的配置文件，初始化mybatis，创建出SqlSessionFactory，是创建SqlSession的工厂
		 * 这里只是为了演示的需要，SqlSessionFactory临时创建出来，在实际的使用中，SqlSessionFactory只需要创建一次，当作单例来使用
		 */
		InputStream inputStream = Resources.getResourceAsStream("mybatisConfig.xml");
		SqlSessionFactoryBuilder builder = new SqlSessionFactoryBuilder();
		SqlSessionFactory factory = builder.build(inputStream);
		
		//2. 从SqlSession工厂 SqlSessionFactory中创建一个SqlSession，进行数据库操作
		SqlSession sqlSession = factory.openSession();
	
		//3.使用SqlSession查询
		Map&lt;String,Object&gt; params = new HashMap&lt;String,Object&gt;();
		
		params.put("min_salary",10000);
		//a.查询工资低于10000的员工
		List&lt;Employee&gt; result = sqlSession.selectList("com.louis.mybatis.dao.EmployeesMapper.selectByMinSalary",params);
		//b.未传最低工资，查所有员工
		List&lt;Employee&gt; result1 = sqlSession.selectList("com.louis.mybatis.dao.EmployeesMapper.selectByMinSalary");
		System.out.println("薪资低于10000的员工数："+result.size());
		//~output :   查询到的数据总数：5  
		System.out.println("所有员工数: "+result1.size());
		//~output :  所有员工数: 8
	}

}
</code></pre>
<h2 id="32-sqlsession工作工程分析">3.2. SqlSession工作工程分析</h2>
<h3 id="321-开启一个数据库访问会话创建sqlsession对象">3.2.1. 开启一个数据库访问会话–创建SqlSession对象</h3>
<pre><code class="language-Java">SqlSession sqlSession = factory.openSession();  
</code></pre>

<p>Mybatis封装了对数据库的访问，把对数据库的会话和事务控制放到了SqlSession对象中。</p>

<p><img src="/ProgramNote/assets/Image/mybatis/20.png" alt="Mybatis设计图" title="设计图" /></p>

<h3 id="322-为sqlsession传递一个配置的sql语句statementid和参数然后返回结果">3.2.2. 为SqlSession传递一个配置的SQL语句StatementId和参数，然后返回结果</h3>
<pre><code class="language-Java">List&lt;Employee&gt; result = sqlSession.selectList("com.louis.mybatis.dao.EmployeesMapper.selectByMinSalary",params);
</code></pre>
<p><strong>com.louis.mybatis.dao.EmployeesMapper.selectByMinSalary</strong>是配置在xml中的statementId， params是传递的查询参数。</p>

<p>selectList的默认实现</p>

<pre><code class="language-Java">
  @Override
  public &lt;E&gt; List&lt;E&gt; selectList(String statement, Object parameter) {
    return this.selectList(statement, parameter, RowBounds.DEFAULT);
  }

  @Override
  public &lt;E&gt; List&lt;E&gt; selectList(String statement, Object parameter, RowBounds rowBounds) {
    try {
      //1、根据Statement Id，在mybatis 配置对象Configuration中查找和配置文件相对应的MappedStatement   
      MappedStatement ms = configuration.getMappedStatement(statement);
      //2、将查询任务委托给Mybatis的执行器Execute
      return executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);
    } catch (Exception e) {
      throw ExceptionFactory.wrapException("Error querying database.  Cause: " + e, e);
    } finally {
      ErrorContext.instance().reset();
    }
  }

</code></pre>

<p>MyBatis在初始化的时候，会将MyBatis的配置信息全部加载到内存中，使用org.apache.ibatis.session.Configuration实例来维护。使用者可以使用sqlSession.getConfiguration()方法来获取。MyBatis的配置文件中配置信息的组织格式和内存中对象的组织格式几乎完全对应的。上述例子中的</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectByMinSalary"</span> <span class="na">resultMap=</span><span class="s">"BaseResultMap"</span> <span class="na">parameterType=</span><span class="s">"java.util.Map"</span> <span class="nt">&gt;</span>
    select 
    	EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, SALARY
    	from LOUIS.EMPLOYEES
    	<span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">"min_salary != null"</span><span class="nt">&gt;</span>
    		where SALARY <span class="err">&lt;</span> #{min_salary,jdbcType=DECIMAL}
    	<span class="nt">&lt;/if&gt;</span>
  <span class="nt">&lt;/select&gt;</span>
</code></pre></div></div>
<p>会加载到内存中生成一个对应的MappedStatement对象，然后以 <code class="highlighter-rouge">key</code> = <code class="highlighter-rouge">com.louis.mybatis.dao.EmployeesMapper.selectByMinSalary</code>, <code class="highlighter-rouge">value</code> = MappedStatement对象的形式维护到Configuration的一个Map中。</p>

<p>总结：</p>

<p>SqlSession根据Statement ID, 在mybatis配置对象Configuration中获取到对应的MappedStatement对象，然后调用mybatis执行器来执行具体的操作。</p>

<h3 id="323-mybatis执行器executor根据sqlsession传递的参数执行query方法">3.2.3. Mybatis执行器Executor根据SqlSession传递的参数执行query()方法</h3>

<pre><code class="language-Java">/**
* BaseExecutor 类部分代码
*
*/
public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler) throws SQLException {
	// 1.根据具体传入的参数，动态地生成需要执行的SQL语句，用BoundSql对象表示  
    BoundSql boundSql = ms.getBoundSql(parameter);
    // 2.为当前的查询创建一个缓存Key
    CacheKey key = createCacheKey(ms, parameter, rowBounds, boundSql);
    return query(ms, parameter, rowBounds, resultHandler, key, boundSql);
 }

  @SuppressWarnings("unchecked")
  public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
    ErrorContext.instance().resource(ms.getResource()).activity("executing a query").object(ms.getId());
    if (closed) throw new ExecutorException("Executor was closed.");
    if (queryStack == 0 &amp;&amp; ms.isFlushCacheRequired()) {
      clearLocalCache();
    }
    List&lt;E&gt; list;
    try {
      queryStack++;
      list = resultHandler == null ? (List&lt;E&gt;) localCache.getObject(key) : null;
      if (list != null) {
        handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);
      } else {
    	// 3.缓存中没有值，直接从数据库中读取数据  
        list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);
      }
    } finally {
      queryStack--;
    }
    if (queryStack == 0) {
      for (DeferredLoad deferredLoad : deferredLoads) {
        deferredLoad.load();
      }
      deferredLoads.clear(); // issue #601
      if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) {
        clearLocalCache(); // issue #482
      }
    }
    return list;
  }
 private &lt;E&gt; List&lt;E&gt; queryFromDatabase(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
    List&lt;E&gt; list;
    localCache.putObject(key, EXECUTION_PLACEHOLDER);
    try {
    	
      //4. 执行查询，返回List 结果，然后	将查询的结果放入缓存之中
      list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);
    } finally {
      localCache.removeObject(key);
    }
    localCache.putObject(key, list);
    if (ms.getStatementType() == StatementType.CALLABLE) {
      localOutputParameterCache.putObject(key, parameter);
    }
    return list;
  }
</code></pre>

<pre><code class="language-Java">/**
*
*SimpleExecutor类的doQuery()方法实现
*
*/
  public &lt;E&gt; List&lt;E&gt; doQuery(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) throws SQLException {
    Statement stmt = null;
    try {
      Configuration configuration = ms.getConfiguration();
      //5. 根据既有的参数，创建StatementHandler对象来执行查询操作
      StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);
      //6. 创建java.Sql.Statement对象，传递给StatementHandler对象
      stmt = prepareStatement(handler, ms.getStatementLog());
      //7. 调用StatementHandler.query()方法，返回List结果集
      return handler.&lt;E&gt;query(stmt, resultHandler);
    } finally {
      closeStatement(stmt);
    }
  }
</code></pre>

<p>上述的<code class="highlighter-rouge">Executor.query()</code>方法几经转折，最后会创建一个<code class="highlighter-rouge">StatementHandler</code>对象，然后将必要的参数传递给<code class="highlighter-rouge">StatementHandler</code>，使用<code class="highlighter-rouge">StatementHandler</code>来完成对数据库的查询，最终返回List结果集。</p>

<p><strong>总结</strong></p>

<ul>
  <li>根据传递的参数，完成SQL语句的动态解析，生成BoundSql对象，供StatementHandler使用；</li>
  <li>为查询创建缓存，以提高性能</li>
  <li>创建JDBC的Statement连接对象，传递给StatementHandler对象，返回List查询结果</li>
</ul>

<h3 id="324-statementhandler对象负责设置statement对象中的查询参数处理jdbc返回的resultset将resultset加工为list-集合返回">3.2.4. StatementHandler对象负责设置Statement对象中的查询参数、处理JDBC返回的resultSet，将resultSet加工为List 集合返回</h3>
<p>看一下：prepareStatement() 方法的实现</p>
<pre><code class="language-Java">/**
*
*SimpleExecutor类的doQuery()方法实现
*
*/
    public &lt;E&gt; List&lt;E&gt; doQuery(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) throws SQLException { 
        Statement stmt = null; 
        try { 
            Configuration configuration = ms.getConfiguration(); 
            StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql); 
            // 1.准备Statement对象，并设置Statement对象的参数 
            stmt = prepareStatement(handler, ms.getStatementLog()); 
            // 2. StatementHandler执行query()方法，返回List结果 
            return handler.&lt;E&gt;query(stmt, resultHandler); 
        } 
        finally 
        { 
            closeStatement(stmt); 
        } 
    }

  private Statement prepareStatement(StatementHandler handler, Log statementLog) throws SQLException {
    Statement stmt;
    Connection connection = getConnection(statementLog);
    stmt = handler.prepare(connection);
    //对创建的Statement对象设置参数，即设置SQL 语句中 ? 设置为指定的参数
    handler.parameterize(stmt);
    return stmt;
  }
</code></pre>

<p><strong>总结</strong></p>
<ul>
  <li>对于JDBC的PreparedStatement类型的对象，创建的过程中，我们使用的是SQL语句字符串会包含 若干个? 占位符，我们其后再对占位符进行设值。
StatementHandler通过parameterize(statement)方法对Statement进行设值；</li>
  <li>StatementHandler通过List<E> query(Statement statement, ResultHandler resultHandler)方法来完成执行Statement，和将Statement对象返回的resultSet封装成List；</E></li>
</ul>

<h3 id="325-statementhandler-的parameterizestatement-方法的实现">3.2.5. StatementHandler 的parameterize(statement) 方法的实现</h3>

<pre><code class="language-Java">/**
*   StatementHandler 类的parameterize(statement) 方法实现 
*/
public void parameterize(Statement statement) throws SQLException {
	//使用ParameterHandler对象来完成对Statement的设值  
    parameterHandler.setParameters((PreparedStatement) statement);
  }
</code></pre>

<pre><code class="language-Java">  /**
   * 
   *ParameterHandler类的setParameters(PreparedStatement ps) 实现
   * 对某一个Statement进行设置参数
   */
  public void setParameters(PreparedStatement ps) throws SQLException {
    ErrorContext.instance().activity("setting parameters").object(mappedStatement.getParameterMap().getId());
    List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();
    if (parameterMappings != null) {
      for (int i = 0; i &lt; parameterMappings.size(); i++) {
        ParameterMapping parameterMapping = parameterMappings.get(i);
        if (parameterMapping.getMode() != ParameterMode.OUT) {
          Object value;
          String propertyName = parameterMapping.getProperty();
          if (boundSql.hasAdditionalParameter(propertyName)) { // issue #448 ask first for additional params
            value = boundSql.getAdditionalParameter(propertyName);
          } else if (parameterObject == null) {
            value = null;
          } else if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) {
            value = parameterObject;
          } else {
            MetaObject metaObject = configuration.newMetaObject(parameterObject);
            value = metaObject.getValue(propertyName);
          }
          
          // 每一个Mapping都有一个TypeHandler，根据TypeHandler来对preparedStatement进行设置参数
          TypeHandler typeHandler = parameterMapping.getTypeHandler();
          JdbcType jdbcType = parameterMapping.getJdbcType();
          if (value == null &amp;&amp; jdbcType == null) jdbcType = configuration.getJdbcTypeForNull();
          // 设置参数
          typeHandler.setParameter(ps, i + 1, value, jdbcType);
        }
      }
    }
  }
</code></pre>

<p><strong>总结</strong></p>
<ul>
  <li>StatementHandler 的parameterize(Statement) 方法调用了 ParameterHandler的setParameters(statement) 方法</li>
  <li>ParameterHandler的setParameters(Statement)方法负责 根据我们输入的参数，对statement对象的 ? 占位符处进行赋值。</li>
</ul>

<h3 id="326-statementhandler-的list-querystatement-statement-resulthandler-resulthandler方法的实现">3.2.6. StatementHandler 的List<E> query(Statement statement, ResultHandler resultHandler)方法的实现</E></h3>
<pre><code class="language-Java">  /**
   * PreParedStatement类的query方法实现
   */
  public &lt;E&gt; List&lt;E&gt; query(Statement statement, ResultHandler resultHandler) throws SQLException {
	// 1.调用preparedStatemnt。execute()方法，然后将resultSet交给ResultSetHandler处理  
    PreparedStatement ps = (PreparedStatement) statement;
    ps.execute();
    //2. 使用ResultHandler来处理ResultSet
    return resultSetHandler.&lt;E&gt; handleResultSets(ps);
  }

</code></pre>

<pre><code class="language-Java">/**  
*ResultSetHandler类的handleResultSets()方法实现
*
*/
public List&lt;Object&gt; handleResultSets(Statement stmt) throws SQLException {
    final List&lt;Object&gt; multipleResults = new ArrayList&lt;Object&gt;();

    int resultSetCount = 0;
    ResultSetWrapper rsw = getFirstResultSet(stmt);

    List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();
    int resultMapCount = resultMaps.size();
    validateResultMapsCount(rsw, resultMapCount);
    
    while (rsw != null &amp;&amp; resultMapCount &gt; resultSetCount) {
      ResultMap resultMap = resultMaps.get(resultSetCount);
      
      //将resultSet
      handleResultSet(rsw, resultMap, multipleResults, null);
      rsw = getNextResultSet(stmt);
      cleanUpAfterHandlingResultSet();
      resultSetCount++;
    }

    String[] resultSets = mappedStatement.getResulSets();
    if (resultSets != null) {
      while (rsw != null &amp;&amp; resultSetCount &lt; resultSets.length) {
        ResultMapping parentMapping = nextResultMaps.get(resultSets[resultSetCount]);
        if (parentMapping != null) {
          String nestedResultMapId = parentMapping.getNestedResultMapId();
          ResultMap resultMap = configuration.getResultMap(nestedResultMapId);
          handleResultSet(rsw, resultMap, null, parentMapping);
        }
        rsw = getNextResultSet(stmt);
        cleanUpAfterHandlingResultSet();
        resultSetCount++;
      }
    }

    return collapseSingleResultList(multipleResults);
  }
</code></pre>

<p>StatementHandler 的List<E> query(Statement statement, ResultHandler resultHandler)方法的实现，是调用了ResultSetHandler的handleResultSets(Statement) 方法。ResultSetHandler的handleResultSets(Statement) 方法会将Statement语句执行后生成的resultSet 结果集转换成List<E> 结果集</E></E></p>

<pre><code class="language-Java">  //
  // DefaultResultSetHandler 类的handleResultSets(Statement stmt)实现 
  //HANDLE RESULT SETS
  //

  public List&lt;Object&gt; handleResultSets(Statement stmt) throws SQLException {
    final List&lt;Object&gt; multipleResults = new ArrayList&lt;Object&gt;();

    int resultSetCount = 0;
    ResultSetWrapper rsw = getFirstResultSet(stmt);

    List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();
    int resultMapCount = resultMaps.size();
    validateResultMapsCount(rsw, resultMapCount);
    
    while (rsw != null &amp;&amp; resultMapCount &gt; resultSetCount) {
      ResultMap resultMap = resultMaps.get(resultSetCount);
      
      //将resultSet
      handleResultSet(rsw, resultMap, multipleResults, null);
      rsw = getNextResultSet(stmt);
      cleanUpAfterHandlingResultSet();
      resultSetCount++;
    }

    String[] resultSets = mappedStatement.getResulSets();
    if (resultSets != null) {
      while (rsw != null &amp;&amp; resultSetCount &lt; resultSets.length) {
        ResultMapping parentMapping = nextResultMaps.get(resultSets[resultSetCount]);
        if (parentMapping != null) {
          String nestedResultMapId = parentMapping.getNestedResultMapId();
          ResultMap resultMap = configuration.getResultMap(nestedResultMapId);
          handleResultSet(rsw, resultMap, null, parentMapping);
        }
        rsw = getNextResultSet(stmt);
        cleanUpAfterHandlingResultSet();
        resultSetCount++;
      }
    }

    return collapseSingleResultList(multipleResults);
  }
</code></pre>
</div>
				<footer><meta itemprop="dateModified" content="2017-12-11T13:51:29+08:00"><div class="article-license"><div class="m-license"><div class="clearfix"><p>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> license.</p><a class="license" rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
      <img alt="Creative Commons License" src="/ProgramNote/assets/images/license-cc4.png" />
    </a><p></p>
  </div>
</div></div>
				</footer><section></section></article>
		</div>
		<div class="col-2">
			<aside class="js-article-aside"><div class="m-toc js-toc"></div></aside>
		</div>
	</div>
</div>

<script src="//cdn.bootcss.com/toc/0.3.2/toc.min.js"></script>
<script type="text/javascript">
	window.throttle = function(func, wait) {
	  var args, result, thisArg, timeoutId, lastCalled = 0;

	  function trailingCall() {
	    lastCalled = new Date;
	    timeoutId = null;
	    result = func.apply(thisArg, args);
	  }
	  return function() {
	    var now = new Date,
	      remaining = wait - (now - lastCalled);

	    args = arguments;
	    thisArg = this;

	    if (remaining <= 0) {
	      clearTimeout(timeoutId);
	      timeoutId = null;
	      lastCalled = now;
	      result = func.apply(thisArg, args);
	    } else if (!timeoutId) {
	      timeoutId = setTimeout(trailingCall, remaining);
	    }
	    return result;
	  };
	}
	$(function() {
	  var $window = $(window);
	  var $pageStage = $('.js-page-stage');
	  var $pageMain = $('.js-main');
	  var $pageFooter = $('.js-page-footer');
	  var $articleContent = $('.js-article-content');
	  var $articleAside = $('.js-article-aside');
	  var $toc = $('.js-toc');
	  var hasTitle = $articleContent.find('h1, h2, h3').length > 0;

	  function asideSticky() {
	    return $window.outerWidth() > 1150 && $pageStage.hasClass('has-toc');
	  }

	  function setTocClass() {
	    if (hasTitle) {
	      !$pageStage.hasClass('has-toc') && $pageStage.addClass('has-toc');
	    }
	  }

	  setTocClass();

	  function setAsideTOC() {
	    var asideTop, asideLeft, scrollBottom, asideBottomTop, lastScrollTop;

	    function init() {
	      var asideOffset = $articleAside.offset();
	      var footerOffset = $pageFooter.offset();
	      var mainOffset = $pageMain.offset();
	      asideTop = mainOffset.top;
	      asideHeight = $toc.outerHeight() + parseInt($articleAside.css('padding-top'), 10) + parseInt($articleAside.css('padding-bottom'), 10);
	      asideLeft = mainOffset.left + $pageMain.outerWidth() - $articleAside.outerWidth() - parseInt($pageMain.css('padding-right'), 10);
	      scrollBottom = footerOffset.top - asideHeight;
	      asideBottomTop = scrollBottom - mainOffset.top;
	    }

	    function setAside(force) {
	      force !== true && (force = false);
	      var scrollTop = $window.scrollTop();
	      if (scrollTop >= asideTop && scrollTop <= scrollBottom) {
	        (!force && lastScrollTop >= asideTop && lastScrollTop <= scrollBottom) ||
	        $articleAside.addClass('fixed').css({
	          left: asideLeft + 'px',
	          top: 0
	        });
	      } else if (scrollTop < asideTop) {
	        (!force && lastScrollTop < asideTop) ||
	        $articleAside.removeClass('fixed').css({
	          left: 0,
	          top: 0
	        });
	      } else {
	        (!force && lastScrollTop > scrollBottom) ||
	        $articleAside.removeClass('fixed').css({
	          left: 0,
	          top: asideBottomTop + 'px'
	        });
	      }
	      lastScrollTop = scrollTop;
	    }
	    asideSticky() && (init(), setAside());
	    $window.on('scroll', function() {
	      asideSticky() && setAside();
	    });
	    $window.on('resize', throttle(function() {
	      setTocClass();
	      asideSticky() && (init(), setAside(true));
	    }, 100));
	    setTimeout(init, 4000);
	  }
	  setTimeout(setAsideTOC, 1000);

	  $toc.toc({
	    'selectors': 'h1,h2,h3',
	    'container': '.js-article-content',
	  });
	});
</script></div>
</div>
</div><div class="m-page-footer js-page-footer">
  <div class="main">
    <aside><div class="follow-me"><ul class="inline-list" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lipeng">
    <link itemprop="url" href="http://localhost:4000/"></ul></div>
</aside>
    <footer class="site-info">
      <p>© lipeng's blog 2015 - 2017</p>
      <p>Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a succinct theme for blogging." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.</p>
    </footer>
  </div>
</div><script>
      $(function() {
        // display coding language
        $(".highlight").each(function() {
          $(this).attr("data-lang", $(this).find("code").attr("data-lang"));
        });
      });
    </script></body>
</html>
